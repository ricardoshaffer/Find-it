var map,store_distP,datasource,popup,fullTP,store_ID,results=[];resultsHalf=[],resultsEmpty=[];var start,end,featuresFULL=[],featuresHALF=[],featuresEMPTY=[],searchOptions={view:"Auto",limit:1},isBusy=!1,addresses=featuresFULL,addressesHalf=featuresHALF,addressesEmpty=featuresEMPTY;function GetMap(){var e=new atlas.Map("myMap",{showFeedbackLink:!1,showLogo:!1,style:"grayscale_light",authOptions:{authType:"subscriptionKey",subscriptionKey:"m_AYIgqMRfb-TR1kp7LsxSOq02rw51cgBrgxLGv6vGU"}}),t=atlas.service.MapsURL.newPipeline(new atlas.service.SubscriptionKeyCredential(atlas.getSubscriptionKey()));searchURL=new atlas.service.SearchURL(t),geoURL=new atlas.service.SearchURL(t),geoURLHALF=new atlas.service.SearchURL(t),geoURLEMPTY=new atlas.service.SearchURL(t),e.events.add("ready",(function(){var t=latitudeLoc,s=longitudeLoc;e.imageSprite.add("going-potty","https://cdn.shopify.com/s/files/1/0251/2525/7269/files/monster-locator-sm.png").then((function(){userLocation=new atlas.source.DataSource,userLocation.add(new atlas.data.Point([s,t])),e.sources.add(userLocation),e.layers.add(new atlas.layer.SymbolLayer(userLocation,null,{iconOptions:{image:"going-potty",anchor:"center",size:.3,allowOverlap:!1}})),e.setCamera({center:[s,t],zoom:10,duration:1e3,type:"fly"})})),datasource=new atlas.source.DataSource,e.sources.add(datasource),async function(){for(var e=[],t=[],s=[],a=0;a<addresses.length;a++)e.push(geoURL.searchAddress(atlas.service.Aborter.timeout(1e4),addresses[a],searchOptions));for(a=0;a<addressesHalf.length;a++)t.push(geoURLHALF.searchAddress(atlas.service.Aborter.timeout(1e4),addressesHalf[a],searchOptions));for(a=0;a<addressesEmpty.length;a++)s.push(geoURLEMPTY.searchAddress(atlas.service.Aborter.timeout(1e4),addressesEmpty[a],searchOptions));var o=await Promise.all(e),r=await Promise.all(t),n=await Promise.all(s);o.forEach(e=>{var t=e.geojson.getFeatures();t.features.length>0&&results.push(t.features[0])}),r.forEach(e=>{var t=e.geojson.getFeatures();t.features.length>0&&resultsHalf.push(t.features[0])}),n.forEach(e=>{var t=e.geojson.getFeatures();t.features.length>0&&resultsEmpty.push(t.features[0])}),end=window.performance.now(),geoSource.setShapes(results),geoHalf.setShapes(resultsHalf),geoEmpty.setShapes(resultsEmpty),isBusy=!1}(),e.imageSprite.add("question-tp","https://cdn.shopify.com/s/files/1/0251/2525/7269/files/question-tp.png");var a=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"question-tp",size:.3,allowOverlap:!0},textOptions:{anchor:"top"}});e.layers.add(a),popup=new atlas.Popup,e.events.add("click",a,o),geoSource=new atlas.source.DataSource,e.sources.add(geoSource),e.imageSprite.add("tp-full","https://cdn.shopify.com/s/files/1/0251/2525/7269/files/tp-full.png");var r=new atlas.layer.SymbolLayer(geoSource,null,{iconOptions:{image:"tp-full",size:.4,allowOverlap:!0}});e.layers.add(r),popup=new atlas.Popup,e.events.add("click",r,o),geoHalf=new atlas.source.DataSource,e.sources.add(geoHalf),e.imageSprite.add("tp-half","https://cdn.shopify.com/s/files/1/0251/2525/7269/files/tp-half.png");var n=new atlas.layer.SymbolLayer(geoHalf,null,{iconOptions:{image:"tp-half",size:.4,allowOverlap:!0}});e.layers.add(n),popup=new atlas.Popup,e.events.add("click",n,o),geoEmpty=new atlas.source.DataSource,e.sources.add(geoEmpty),e.imageSprite.add("tp-empty","https://cdn.shopify.com/s/files/1/0251/2525/7269/files/tp-empty.png");var l=new atlas.layer.SymbolLayer(geoEmpty,null,{iconOptions:{image:"tp-empty",size:.4,allowOverlap:!0}});e.layers.add(l),popup=new atlas.Popup,e.events.add("click",l,o)}));var s=latitudeLoc,a=longitudeLoc;function o(t){var s=t.shapes[0].getProperties(),a=t.shapes[0].getCoordinates();let o=t.shapes[0].getProperties();for(storeData=0;storeData<10;storeData++)store_ID=o.id,store_Name=o.poi.name,store_address=o.address.freeformAddress,store_Long=a[0],store_Lat=a[1],store_distance=o.dist,store_distP=parseInt(store_distance),store_Inventory=3;var r=`\n       <div style="padding:5px;">\n       <div><b>${s.poi.name}</b></div>\n       <div>${s.address.freeformAddress}</div>\n       </div>`;if(store_distP<1e3)var n=`\n         <span id="store-ID-popup" class="store-ID-popup">\n         <form name="radio-buttons">\n         <h2>how much is avail?</h2> \n     <div class="row">\n       <label class="col">\n         <input type="radio" name="tp-status" value="0" >\n         <img class="col img-fluid" width="50px" src="img/tp-empty-icon.svg" alt="no toilet paper" data-toggle="tooltip" data-placement="top" title="no toilet paper">\n       </label>\n       <label class="col">\n         <input type="radio" name="tp-status" value="1">\n         <img class="col img-fluid" width="50px" data-toggle="tooltip" data-placement="top" title="moderate amount of toilet paper" src="img/tp-half-icon.svg" alt="moderate amount of toilet paper">\n       </label>\n       <label class="col">\n         <input type="radio" name="tp-status" value="2">\n         <img class="col img-fluid" width="50px" src="img/tp-full-icon.svg" alt="tons of toilet paper" data-toggle="tooltip" data-placement="top" title="plenty of toilet paper!">\n       </label>\n       \x3c!-- Left as default selected radio button incase user doesn't select the options above. So we can identify junk in our db --\x3e\n       <label style="display: none;">\n         <input type="radio" name="tp-status" value="3" checked>\n       </label>\n     </div>\n   </form>\n   <div class="row">\n   <div class="modal-footer" id="submit-btn">\n       <button type="button" value="${s.id}" class="btn btn-primary" id="submit-button" onclick="submitTP()">Submit</button>\n   </div>\n    </span>`;else n="<span></span>";store_distP<1e3?$("#store-ID-popup").attr("display","inline"):$("#store-ID-popup").attr("display","none"),popup.setPopupOptions({content:r+n,position:a});let l={store_name:s.poi.name,store_address:s.address.freeformAddress,uniqueID:store_ID,availability:store_Inventory,longlat:store_Long+","+store_Lat};$.ajax({method:"POST",url:"/api/stores",data:l}).then((function(){console.log("new store added!")})),popup.open(e)}searchURL.searchPOI(atlas.service.Aborter.timeout(1e4),"grocery-store",{limit:10,lat:s,lon:a,radius:9e3}).then(e=>{var t=e.geojson.getFeatures();datasource.add(t)})}function submitTP(){var e=$("input[name='tp-status']:checked").val(),t=$("#submit-button").val();console.log("you chose "+e),console.log(t),sendTPStatus(t,e)}$.get("/api/stores",(function(e){storesinfo=e,storesinfo.forEach(e=>{uniqueTag=e.id,storeAddress=e.store_address,storeInventory=e.availability,existingStore=e.longlat,2===storeInventory&&featuresFULL.push(storeAddress),1===storeInventory&&featuresHALF.push(storeAddress),0===storeInventory&&featuresEMPTY.push(storeAddress)})}));